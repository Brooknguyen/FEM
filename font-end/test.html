<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trình xem và Xuất file Excel</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f9;
        }
        h1, h2 {
            color: #333;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            font-size: 14px;
            margin-top: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            background-color: #fff;
        }
        th, td {
            border: 1px solid #dddddd;
            text-align: left;
            padding: 10px;
            vertical-align: middle;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .section-header {
            background-color: #e0e0e0;
            font-weight: bold;
        }
        button, input[type="file"] {
            margin-top: 20px;
            padding: 10px 15px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 5px;
            border: 1px solid #ccc;
            background-color: #007bff;
            color: white;
        }
        input[type="file"] {
             background-color: #6c757d;
        }
        #exportButton {
            display: none; /* Ẩn nút xuất ban đầu */
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>

    <h1>Trình xem dữ liệu từ File Excel</h1>
    <h2>1. Chọn file Excel (.xlsx, .xls) của bạn:</h2>
    <input type="file" id="excelFile" accept=".xlsx, .xls"/>

    <div id="table-container">
        <table id="dataTable"></table>
    </div>

    <button id="exportButton">Xuất lại ra file Excel</button>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const excelFileInput = document.getElementById('excelFile');
            const dataTable = document.getElementById('dataTable');
            const exportButton = document.getElementById('exportButton');

            excelFileInput.addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (!file) {
                    return;
                }

                const reader = new FileReader();

                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    // Đọc dữ liệu từ file Excel
                    const workbook = XLSX.read(data, { type: 'array' });

                    // Lấy sheet đầu tiên
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // Chuyển sheet thành một mảng của các mảng (Array of Arrays)
                    // {defval: ''} để đảm bảo ô trống là chuỗi rỗng
                    const sheetData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });

                    // Vẽ bảng từ dữ liệu đã đọc
                    renderTable(sheetData, dataTable);

                    // Hiển thị nút xuất sau khi đã có bảng
                    exportButton.style.display = 'block';
                };

                reader.readAsArrayBuffer(file);
            });
            
            // Hàm renderTable giữ nguyên logic như trước để xử lý cấu trúc gộp ô
            function renderTable(data, tableElement) {
                if (!data || data.length < 2) {
                    tableElement.innerHTML = "<tr><td>Không có dữ liệu hoặc định dạng không đúng.</td></tr>";
                    return;
                }
                
                let html = '<thead>';
                
                // Dòng header 1
                html += '<tr>';
                html += `<th rowspan="2">${data[0][0]}</th>`; // Tên máy
                html += `<th rowspan="2">${data[0][2]}</th>`; // Loại đối tượng
                html += `<th rowspan="2">${(data[0][3] || '').replace('\n', '<br>')}</th>`; // Ký hiệu
                html += `<th rowspan="2">${data[0][4]}</th>`; // Card no
                html += `<th colspan="4">${data[0][5]}</th>`; // Thông số kỹ thuật
                html += `<th rowspan="2">${data[0][9]}</th>`; // Hãng sản xuất
                html += `<th rowspan="2">${data[0][10]}</th>`; // Xuất xứ
                html += `<th rowspan="2">${(data[0][11] || '').replace('\n', '<br>')}</th>`; // Năm chế tạo
                html += `<th rowspan="2">${data[0][12]}</th>`; // Vị trí
                html += `<th rowspan="2">${data[0][13]}</th>`; // Địa điểm
                html += '</tr>';

                // Dòng header 2
                html += '<tr>';
                for (let i = 6; i <= 9; i++) {
                     html += `<th>${(data[1][i] || '').replace('\n', '<br>')}</th>`;
                }
                html += '</tr></thead><tbody>';

                // Xử lý các dòng dữ liệu
                for (let i = 2; i < data.length; i++) {
                    const row = data[i];
                    if (row.every(cell => cell === '')) continue; // Bỏ qua dòng hoàn toàn trống

                    // Kiểm tra nếu là dòng tiêu đề mục
                    if (row[0] && row.slice(1).every(cell => cell === '')) {
                        html += `<tr><td colspan="13" class="section-header">${row[0]}</td></tr>`;
                    } else {
                        let rowspan = 1;
                        if (row[0] !== '') {
                            for (let j = i + 1; j < data.length; j++) {
                                if (data[j][0] === '') {
                                    rowspan++;
                                } else {
                                    break;
                                }
                            }
                        }

                        html += '<tr>';
                        if (row[0] !== '') {
                             html += `<td rowspan=${rowspan}>${row[0]}</td>`;
                        }
                        for (let j = 1; j < 14; j++) { // Lặp qua 13 cột còn lại
                           html += `<td>${row[j] || ''}</td>`;
                        }
                        html += '</tr>';
                    }
                }
                html += '</tbody>';
                tableElement.innerHTML = html;
            }

            // Gán sự kiện cho nút Xuất Excel
            exportButton.addEventListener('click', function() {
                // Chuyển đổi bảng HTML đã hiển thị thành một workbook
                const wb = XLSX.utils.table_to_book(dataTable, { sheet: "Sheet1" }); 
                
                // Xuất file Excel
                XLSX.writeFile(wb, "DuLieuXuatRa.xlsx");
            });
        });
    </script>

</body>
</html>